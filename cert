#!/bin/bash

# Configuration
CSV_FILE="/path/to/your/certificates.csv"
LOG_FILE="/tmp/cert_expiry_check.log"
EMAIL_TO="your_email@example.com"
TODAY=$(date +%Y-%m-%d)
THRESHOLD_DATE=$(date -d "+30 days" +%Y-%m-%d)
TEMP_FILE="/tmp/expiring_items.txt"

# Initialize
echo "[$(date)] Running certificate expiry check" > "$LOG_FILE"

# Check if CSV file exists
if [ ! -f "$CSV_FILE" ]; then
  echo "ERROR: CSV file not found at $CSV_FILE" >> "$LOG_FILE"
  echo "Certificate check failed. CSV file missing." | mailx -s "Cert Expiry Script Error" "$EMAIL_TO"
  exit 1
fi

# Prepare temp file
> "$TEMP_FILE"

# Read and process CSV
{
  read # skip header
  while IFS=, read -r name expiry; do
    name=$(echo "$name" | xargs)
    expiry=$(echo "$expiry" | xargs)

    # Validate expiry date
    if ! date -d "$expiry" &>/dev/null; then
      echo "WARNING: Invalid date for '$name': $expiry" >> "$LOG_FILE"
      continue
    fi

    if [[ "$expiry" > "$TODAY" && "$expiry" <= "$THRESHOLD_DATE" ]]; then
      echo "$name is expiring on $expiry" >> "$TEMP_FILE"
      echo "ALERT: $name is expiring on $expiry" >> "$LOG_FILE"
    fi
  done
} < "$CSV_FILE"

# Send email if any expiring items found
if [ -s "$TEMP_FILE" ]; then
  mailx -s "Certificates Expiring in Next 30 Days" "$EMAIL_TO" < "$TEMP_FILE"
fi

# Cleanup
rm -f "$TEMP_FILE"
echo "[$(date)] Check complete" >> "$LOG_FILE"
